<!DOCTYPE html>
<html lang="de-de"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="content-type" content="text/html">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title itemprop="name">VCF 9 VKS mit NSX VPC und Antrea Egress | vi-universe.github.io | Christian Kremer</title>
<meta property="og:title" content="VCF 9 VKS mit NSX VPC und Antrea Egress | vi-universe.github.io | Christian Kremer" />
<meta name="twitter:title" content="VCF 9 VKS mit NSX VPC und Antrea Egress | vi-universe.github.io | Christian Kremer" />
<meta itemprop="name" content="VCF 9 VKS mit NSX VPC und Antrea Egress | vi-universe.github.io | Christian Kremer" />
<meta name="application-name" content="VCF 9 VKS mit NSX VPC und Antrea Egress | vi-universe.github.io | Christian Kremer" />
<meta property="og:site_name" content="vi-universe.github.io" />

<meta name="description" content="vi-universe.github.io | Christian Kremer">
<meta itemprop="description" content="vi-universe.github.io | Christian Kremer" />
<meta property="og:description" content="vi-universe.github.io | Christian Kremer" />
<meta name="twitter:description" content="vi-universe.github.io | Christian Kremer" />

<meta property="og:locale" content="de-de" />
<meta name="language" content="de-de" />

  <link rel="alternate" hreflang="de-de" href="http://localhost:1313/posts/nsx_vpc_vks/" title="German" />





    
    
    

    <meta property="og:type" content="article" />
    <meta property="og:article:published_time" content=2025-10-21T00:00:00Z />
    <meta property="article:published_time" content=2025-10-21T00:00:00Z />
    <meta property="og:url" content="http://localhost:1313/posts/nsx_vpc_vks/" />

    
    <meta property="og:article:author" content="Christian Kremer" />
    <meta property="article:author" content="Christian Kremer" />
    <meta name="author" content="Christian Kremer" />
    
    

    

    <script defer type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "Article",
        "headline": "VCF 9 VKS mit NSX VPC und Antrea Egress",
        "author": {
        "@type": "Person",
        "name": ""
        },
        "datePublished": "2025-10-21",
        "description": "",
        "wordCount":  1205 ,
        "mainEntityOfPage": "True",
        "dateModified": "2025-10-21",
        "image": {
        "@type": "imageObject",
        "url": ""
        },
        "publisher": {
        "@type": "Organization",
        "name": "vi-universe.github.io | Christian Kremer"
        }
    }
    </script>


<meta name="generator" content="Hugo 0.147.8">

    
    <meta property="og:url" content="http://localhost:1313/posts/nsx_vpc_vks/">
  <meta property="og:site_name" content="vi-universe.github.io | Christian Kremer">
  <meta property="og:title" content="VCF 9 VKS mit NSX VPC und Antrea Egress">
  <meta property="og:description" content="Mit dem Release von VMware Cloud Foundation (VCF) 9 hat sich die Art und Weise, wie Kubernetes-Infrastruktur bereitgestellt wird, grundlegend weiterentwickelt. Der vSphere Kubernetes Service (VKS) kann nun das neue NSX VPC-Modell nutzen, um Entwicklern echte Self-Service-Funktionen bei gleichzeitig strikter Isolation zu bieten.
In diesem Beitrag schauen wir uns an, wie das Zusammenspiel zwischen VKS, den virtuellen privaten Netzwerken (VPCs) und dem Container Networking Interface (CNI) Antrea funktioniert.
Ressourcen zur Bereitstellung Bevor wir in die technischen Details einsteigen: In diesem Beitrag setze ich voraus, dass die Grundz√ºge von VCF 9 bekannt sind. Wenn du eine Schritt-f√ºr-Schritt-Anleitung zur initialen Bereitstellung suchst, empfehle ich diese exzellenten Quellen:">
  <meta property="og:locale" content="de_de">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-10-21T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-10-21T00:00:00+00:00">


    
    
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="VCF 9 VKS mit NSX VPC und Antrea Egress">
  <meta name="twitter:description" content="Mit dem Release von VMware Cloud Foundation (VCF) 9 hat sich die Art und Weise, wie Kubernetes-Infrastruktur bereitgestellt wird, grundlegend weiterentwickelt. Der vSphere Kubernetes Service (VKS) kann nun das neue NSX VPC-Modell nutzen, um Entwicklern echte Self-Service-Funktionen bei gleichzeitig strikter Isolation zu bieten.
In diesem Beitrag schauen wir uns an, wie das Zusammenspiel zwischen VKS, den virtuellen privaten Netzwerken (VPCs) und dem Container Networking Interface (CNI) Antrea funktioniert.
Ressourcen zur Bereitstellung Bevor wir in die technischen Details einsteigen: In diesem Beitrag setze ich voraus, dass die Grundz√ºge von VCF 9 bekannt sind. Wenn du eine Schritt-f√ºr-Schritt-Anleitung zur initialen Bereitstellung suchst, empfehle ich diese exzellenten Quellen:">


    

    <link rel="canonical" href="http://localhost:1313/posts/nsx_vpc_vks/">
    <link href="/style.min.cf5e90893fe6ed558990ae94c193d330841d6aabc33aa8f6f65ef6e15b25378e.css" rel="stylesheet">
    <link href="/code-highlight.min.706d31975fec544a864cb7f0d847a73ea55ca1df91bf495fd12a177138d807cf.css" rel="stylesheet">

    
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg">
    <link rel="shortcut icon" href="/favicon.ico">




<link rel="manifest" href="http://localhost:1313/site.webmanifest">

<meta name="msapplication-config" content="/browserconfig.xml">
<meta name="msapplication-TileColor" content="#2d89ef">
<meta name="theme-color" content="#434648">

    
    <link rel="icon" type="image/svg+xml" href="/icons/favicon.svg">

    
    
      <meta name="google-site-verification" content="8-AAlYVqr7YS51n8n8D6dd01y8cm0kociCCSSUTR7LQ" />

    
</head>
<body data-theme = "auto" class="notransition">

<script src="/js/theme.js"></script>

<div class="navbar" role="navigation">
    <nav class="menu" aria-label="Main Navigation">
        <a href="http://localhost:1313/" class="logo">
            <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" 
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" 
stroke-linejoin="round" class="feather feather-home">
<title>Startseite</title>
<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
<polyline points="9 22 9 12 15 12 15 22"></polyline>
</svg>
        </a>
        <input type="checkbox" id="menu-trigger" class="menu-trigger" />
        <label for="menu-trigger">
            <span class="menu-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" stroke="currentColor" fill="none" viewBox="0 0 14 14"><title>Menu</title><path stroke-linecap="round" stroke-linejoin="round" d="M10.595 7L3.40726 7"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 3.51488L3.49301 3.51488"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 10.4851H3.49301"></path><path stroke-linecap="round" stroke-linejoin="round" d="M0.5 12.5V1.5C0.5 0.947715 0.947715 0.5 1.5 0.5H12.5C13.0523 0.5 13.5 0.947715 13.5 1.5V12.5C13.5 13.0523 13.0523 13.5 12.5 13.5H1.5C0.947715 13.5 0.5 13.0523 0.5 12.5Z"></path></svg>
            </span>
        </label>

        <div class="trigger">
            <ul class="trigger-container">
                
                
                <li>
                    <a class="menu-link " href="/">
                        Startseite
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link active" href="/posts/">
                        Beitr√§ge
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="/pages/about/">
                        √úber mich
                    </a>
                    
                </li>
                
                <li class="menu-separator">
                    <span>|</span>
                </li>
                
                
            </ul>
            <a id="mode" href="#">
                <svg xmlns="http://www.w3.org/2000/svg" class="mode-sunny" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>LIGHT</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
                <svg xmlns="http://www.w3.org/2000/svg" class="mode-moon" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>DARK</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
            </a>
        </div>
    </nav>
</div>

<div class="wrapper post">
    <main class="page-content" aria-label="Content">
        <article>
            <header class="header">
                <h1 class="header-title">VCF 9 VKS mit NSX VPC und Antrea Egress</h1>
                
                
                
                <div class="post-meta">
                    <time datetime="2025-10-21T00:00:00&#43;00:00" itemprop="datePublished"> 21.10.2025 </time>
                </div>
                
            </header>
            
    
    <details class="toc" ZgotmplZ>
        <summary><b>Inhaltsverzeichnis</b></summary>
        <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li>
          <ul>
            <li><a href="#ressourcen-zur-bereitstellung">Ressourcen zur Bereitstellung</a></li>
            <li><a href="#was-ist-egress">Was ist Egress?</a></li>
            <li><a href="#wie-funktioniert-es">Wie funktioniert es?</a></li>
            <li><a href="#typische-einsatzszenarien">Typische Einsatzszenarien:</a></li>
            <li><a href="#standard-egress-verhalten">Standard Egress Verhalten</a></li>
            <li><a href="#antrea-egress-im-vks-paradigma">Antrea Egress im VKS-Paradigma</a></li>
            <li><a href="#egress-separate-subnet">Egress Separate Subnet</a></li>
            <li><a href="#egress-√ºber-nsx-child-segmente--egress-separate-subnet">Egress √ºber NSX Child-Segmente / Egress Separate Subnet</a></li>
            <li><a href="#schritte-zur-aktivierung-von-antrea-egressseparatesubnet">Schritte zur Aktivierung von Antrea EgressSeparateSubnet</a></li>
            <li><a href="#egressseparatesubnet">EgressSeparateSubnet</a></li>
            <li><a href="#subnetz-auf-dem-supervisor-erstellen">Subnetz auf dem Supervisor erstellen</a></li>
            <li><a href="#subnetz-definition-anwenden">Subnetz-Definition anwenden</a></li>
            <li><a href="#subnetconnectionbindingmap">SubnetConnectionBindingMap</a></li>
            <li><a href="#antrea-externalippool">Antrea ExternalIPPool</a></li>
            <li><a href="#antrea-egress-ressource">Antrea Egress-Ressource</a></li>
            <li><a href="#validierung-und-test-der-konfiguration">Validierung und Test der Konfiguration</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
    </details>
            <div class="page-content">
                <p>Mit dem Release von <strong>VMware Cloud Foundation (VCF) 9</strong> hat sich die Art und Weise, wie Kubernetes-Infrastruktur bereitgestellt wird, grundlegend weiterentwickelt. Der <strong>vSphere Kubernetes Service (VKS)</strong> kann nun das neue <strong>NSX VPC-Modell</strong> nutzen, um Entwicklern echte Self-Service-Funktionen bei gleichzeitig strikter Isolation zu bieten.</p>
<p>In diesem Beitrag schauen wir uns an, wie das Zusammenspiel zwischen VKS, den virtuellen privaten Netzwerken (VPCs) und dem Container Networking Interface (CNI) <strong>Antrea</strong> funktioniert.</p>
<hr>
<h4 id="ressourcen-zur-bereitstellung">Ressourcen zur Bereitstellung</h4>
<p>Bevor wir in die technischen Details einsteigen: In diesem Beitrag setze ich voraus, dass die Grundz√ºge von VCF 9 bekannt sind. Wenn du eine Schritt-f√ºr-Schritt-Anleitung zur initialen Bereitstellung suchst, empfehle ich diese exzellenten Quellen:</p>
<ul>
<li><strong>VKS Deployment:</strong> Wer wissen m√∂chte, wie man VKS mit NSX unter VCF 9 bereitstellt, findet bei <strong>Steven Schramm</strong> einen detaillierten Guide:<br>
üëâ <a href="https://sdn-techtalk.com/posts/vks-vpc/">VKS mit NSX VPC ‚Äì sdn-techtalk.com</a></li>
<li><strong>NSX VPC Deep Dive:</strong> F√ºr ein tieferes Verst√§ndnis der Architektur hinter den NSX VPCs (Quotas, IPAM und Routing) ist die Blog-Serie von <strong>Daniel Krieger</strong> die beste Anlaufstelle:<br>
üëâ <a href="https://sdn-warrior.org/posts/vcf9-nsx-vpc/">VCF 9 - NSX VPC Part 1 bis 3 ‚Äì sdn-warrior.org</a></li>
</ul>
<hr>
<h4 id="was-ist-egress">Was ist Egress?</h4>
<p><strong>Egress</strong> ist eine CRD-API (Custom Resource Definition), die den externen Zugriff von Pods innerhalb eines Clusters verwaltet. Sie erm√∂glicht es festzulegen, welche <strong>Egress-IP (SNAT)</strong> der ausgehende Datenverkehr von ausgew√§hlten Pods in das externe Netzwerk verwenden soll.</p>
<h4 id="wie-funktioniert-es">Wie funktioniert es?</h4>
<p>Wenn ein ausgew√§hlter Pod auf das externe Netzwerk zugreift, wird der Egress-Traffic durch einen Tunnel zu dem Node geleitet, der die entsprechende Egress-IP hostet (falls dies ein anderer Node ist als der, auf dem der Pod l√§uft). Beim Verlassen dieses Nodes wird der Traffic dann per <strong>SNAT</strong> (Source Network Address Translation) auf die definierte Egress-IP umgeschrieben.</p>
<h4 id="typische-einsatzszenarien">Typische Einsatzszenarien:</h4>
<ul>
<li><strong>Konsistente IP-Adressen:</strong> Wenn bestimmte Pods eine dauerhaft gleichbleibende IP-Adresse ben√∂tigen, um sich mit Diensten au√üerhalb des Clusters zu verbinden ‚Äì etwa f√ºr die Quellverfolgung in Audit-Logs oder f√ºr die Filterung nach Quell-IPs in externen Firewalls.</li>
<li><strong>Gezielte Verkehrssteuerung:</strong> Wenn du erzwingen m√∂chtest, dass ausgehende externe Verbindungen den Cluster √ºber ganz bestimmte Nodes verlassen, sei es aufgrund von Sicherheitskontrollen oder Einschr√§nkungen in der Netzwerktopologie.</li>
</ul>
<h4 id="standard-egress-verhalten">Standard Egress Verhalten</h4>
<ul>
<li><strong>Node-SNAT:</strong> Wenn ein Pod mit einem Ziel au√üerhalb des Kubernetes-Clusters kommuniziert, wird seine Quell-IP standardm√§√üig auf die IP-Adresse des Worker-Nodes umgeschrieben (SNAT), auf dem der Pod gerade l√§uft.</li>
</ul>
<h4 id="antrea-egress-im-vks-paradigma">Antrea Egress im VKS-Paradigma</h4>
<p>Der ausgehende Datenverkehr (Outbound Traffic) der VKS-Cluster-Nodes l√§uft normalerweise √ºber ein SNAT. Dies geschieht entweder am <strong>VPC Gateway</strong> (bei Supervisor-Clustern mit VCF Networking und VPC) oder am <strong>vSphere Namespace Tier-1 Gateway</strong> (im NSX Classic Mode).</p>
<p>Dies f√ºhrt zu einer Komplikation: Die spezifische <strong>Antrea Egress-IP geht durch das SNAT verloren</strong>. Infolgedessen sieht die Ziel-Workload (egal ob VM, Bare-Metal-Server oder Container-Workload) nicht die Antrea Egress-IP als Quelle des Traffics, sondern die durch SNAT √ºbersetzte IP.</p>
<p><em>Hinweis: Dies gilt f√ºr Szenarien, bei denen das Ziel au√üerhalb des Quell-vSphere-Namespace liegt. Befindet sich das Ziel im selben Namespace, wird der Traffic verteilt und unterliegt keinem SNAT.</em></p>
<h4 id="egress-separate-subnet">Egress Separate Subnet</h4>
<p>Durch das aktivieren von <strong>EgressSeparateSubnet</strong> wird die Funktion erm√∂glicht, Egress-IPs aus einem anderen Subnetz zuzuweisen als dem Standard-Node-Subnetz.</p>
<h4 id="egress-√ºber-nsx-child-segmente--egress-separate-subnet">Egress √ºber NSX Child-Segmente / Egress Separate Subnet</h4>
<p>Dieses Problem kann gel√∂st werden, indem der Antrea Egress mit einem <strong>NSX Child-Segment</strong> verkn√ºpft wird. Dabei dient das Segment der VKS-Cluster-Nodes als √ºbergeordnetes Segment (Parent Segment). Innerhalb jeder VKS-Cluster-Node-VM ist <strong>Open vSwitch (OVS)</strong> daf√ºr verantwortlich, den Netzwerkverkehr mit der entsprechenden VLAN-ID zu taggen, bevor die Pakete √ºber die virtuelle Netzwerkschnittstelle (vNIC) √ºbertragen werden. Dieses Tagging stellt sicher, dass die Pakete innerhalb der Netzwerkinfrastruktur korrekt identifiziert und ohne IP-Verlust geroutet werden.</p>
<h4 id="schritte-zur-aktivierung-von-antrea-egressseparatesubnet">Schritte zur Aktivierung von Antrea EgressSeparateSubnet</h4>
<p>Die &ldquo;Highlevel&rdquo; Schritte zur Aktivierung von <strong>Antrea EgressSeparateSubnet</strong> auf einem VKS-Cluster sind wie folgt:</p>
<ol>
<li><strong>EgressSeparateSubnet aktivieren:</strong> Aktiviere das Feature in der <code>antreaconfig</code>-Konfiguration des Ziel-VKS-Clusters.</li>
<li><strong>Subnetz auf dem Supervisor erstellen:</strong> Erstelle ein neues Subnetz auf dem Supervisor-Cluster mit dem gew√ºnschten CIDR-Bereich.</li>
<li><strong>SubnetConnectionBindingMap erstellen:</strong> Erstelle eine <code>SubnetConnectionBindingMap</code> CR (Custom Resource) auf dem Supervisor-Cluster, um das <code>SubnetSet</code> des aktuellen Clusters mit dem gew√ºnschten VLAN zu verkn√ºpfen.</li>
<li><strong>Antrea ExternalIPPool konfigurieren:</strong> Erstelle einen <code>ExternalIPPool</code> innerhalb des Kubernetes-Clusters (auf dem Antrea l√§uft) unter Verwendung der zugewiesenen Daten (CIDR, Gateway und VLAN).</li>
<li><strong>Antrea Egress-Ressource anlegen:</strong> Erstelle die Antrea <code>Egress</code>-Ressource und verweise dabei auf den neu angelegten <code>ExternalIPPool</code>.</li>
</ol>
<h4 id="egressseparatesubnet">EgressSeparateSubnet</h4>
<p>Bevor der VKS-Workload-Cluster erstellt wird, muss die Netzwerkkonfiguration im entsprechenden vSphere Namespace angepasst werden. Dies geschieht √ºber die <code>AntreaConfig</code> Custom Resource.</p>
<p>Besonders wichtig ist hierbei die Aktivierung des Feature Gates <code>EgressSeparateSubnet</code>, um die sp√§tere Zuweisung dedizierter Egress-IPs zu erm√∂glichen, sowie die Aktivierung der NSX-Integration.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">cni.tanzu.vmware.com/v1alpha1](https://cni.tanzu.vmware.com/v1alpha1)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">AntreaConfig</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tkc-a-antrea-package</span><span class="w"> </span><span class="c"># Das Prefix ist zwingend erforderlich</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">ns-vks-lab</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">antrea</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">featureGates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">EgressSeparateSubnet</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">NodePortLocal</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">antreaNSX</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">enable</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c"># Standardm√§√üig auf false; muss f√ºr NSX-Integration aktiviert werden</span><span class="w">
</span></span></span></code></pre></div><h4 id="subnetz-auf-dem-supervisor-erstellen">Subnetz auf dem Supervisor erstellen</h4>
<p>Nachdem die <code>AntreaConfig</code> vorbereitet wurde, muss das eigentliche Netzwerksegment auf Supervisor-Ebene definiert werden. Hierbei ist das Feld <code>accessMode</code> entscheidend, m√∂gliche Werte sind hierbei <strong>Public</strong>, <strong>PrivateTGW</strong> oder <strong>Private</strong>.|
Auf die jeweiligen Unterschiede und wann, wo und wie ein NAT passiert geht mein Kollegen Daniel Krieger in seinem Blog Artikel ein.
üëâ <a href="https://sdn-warrior.org/posts/vcf9-nsx-vpc/#external-connectivity">VCF 9 - NSX VPC External-Connectivity‚Äì sdn-warrior.org</a></p>
<p>In diesem Beispiel erstellen wir ein Subnetz mit Public Subnet. Die &ldquo;ipAddresses&rdquo; muss ein Subnetz aus dem External IP-Address Block des Projects sein.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">crd.nsx.vmware.com/v1alpha1](https://crd.nsx.vmware.com/v1alpha1)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Subnet</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">egress1-public-sn</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">accessMode</span><span class="p">:</span><span class="w"> </span><span class="l">Public</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">subnetDHCPConfig</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l">DHCPDeactivated</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ipAddresses</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="m">10.172.66.16</span><span class="l">/28</span><span class="w">
</span></span></span></code></pre></div><h4 id="subnetz-definition-anwenden">Subnetz-Definition anwenden</h4>
<p>Das Subnetz wird direkt im <strong>Supervisor-Kontext</strong> erstellt. Wichtig ist dabei, dass der Befehl gegen den Namespace ausgef√ºhrt wird, in dem dein VKS-Cluster betrieben wird.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl apply -f egress-subnet.yaml -n ns-vks-lab
</span></span></code></pre></div><figure><a href="ippool-subnet.png"><img src="/nsx_vpc_vks/ippool-subnet.png"
    alt="NSX VPC IP-Pool Subnetz"></a><figcaption>
      <p>NSX VPC IP-Pool √úbersicht ‚Äì Klick zum Vergr√∂√üern</p>
    </figcaption>
</figure>

<h4 id="subnetconnectionbindingmap">SubnetConnectionBindingMap</h4>
<p>Nachdem das Subnetz erstellt wurde, muss es logisch mit dem SubnetSet verkn√ºpft werden. Dies geschieht √ºber die <code>SubnetConnectionBindingMap</code>. Diese Ressource bildet die Br√ºcke zwischen dem definierten Subnetz und dem spezifischen <code>SubnetSet</code> deines Clusters.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">crd.nsx.vmware.com/v1alpha1](https://crd.nsx.vmware.com/v1alpha1)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">SubnetConnectionBindingMap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">egress1-public-sn-binding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">subnetName</span><span class="p">:</span><span class="w"> </span><span class="l">egress1-public-sn     </span><span class="w"> </span><span class="c"># Name des zuvor erstellten Subnets</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">targetSubnetSetName</span><span class="p">:</span><span class="w"> </span><span class="l">tkc-a-7vb9q  </span><span class="w"> </span><span class="c"># Das SubnetSet deines VKS-Clusters</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">vlanTrafficTag</span><span class="p">:</span><span class="w"> </span><span class="m">16</span><span class="w">                 </span><span class="c"># Die VLAN-ID f√ºr das Tagging (OVS)</span><span class="w">
</span></span></span></code></pre></div><h5 id="identifikation-des-subnet-sets">Identifikation des Subnet Sets</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Abfrage im Supervisor-Kontext</span>
</span></span><span class="line"><span class="cl">kubectl get vsphereclusters -n ns-vks-lab -o yaml <span class="p">|</span> grep name
</span></span></code></pre></div><ul>
<li>Ausgabe:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cluster.x-k8s.io/cloned-from-name: tkc-infrastructure-v3.5.0
</span></span><span class="line"><span class="cl">      cluster.x-k8s.io/cluster-name: tkc-a
</span></span><span class="line"><span class="cl">    name: tkc-a-7vb9q  <span class="c1"># &lt;--- Dies ist der Name f√ºr targetSubnetSetName</span>
</span></span><span class="line"><span class="cl">    namespace: ns-vks-lab
</span></span><span class="line"><span class="cl">      name: tkc-a
</span></span></code></pre></div><h4 id="antrea-externalippool">Antrea ExternalIPPool</h4>
<p>Innerhalb des <strong>Workload-Clusters</strong> definieren wir nun den IP-Pool, den Antrea f√ºr die Egress-Zuweisung nutzen soll. Die <code>vlan</code>-ID muss dabei zwingend mit dem <code>vlanTrafficTag</code> aus der zuvor erstellten <code>SubnetConnectionBindingMap</code> auf dem Supervisor √ºbereinstimmen.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ExternalIPPool</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">egress1-ext-ippool</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ipRanges</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">start</span><span class="p">:</span><span class="w"> </span><span class="m">10.172.66.18</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">end</span><span class="p">:</span><span class="w"> </span><span class="m">10.172.66.30</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">subnetInfo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">gateway</span><span class="p">:</span><span class="w"> </span><span class="m">10.172.66.17</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">prefixLength</span><span class="p">:</span><span class="w"> </span><span class="m">28</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">vlan</span><span class="p">:</span><span class="w"> </span><span class="m">16</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Optional: Selektion spezifischer Nodes f√ºr den Egress-Traffic</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># matchLabels:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c">#   network-role: egress-gateway</span><span class="w">
</span></span></span></code></pre></div><h4 id="antrea-egress-ressource">Antrea Egress-Ressource</h4>
<p>Mit der <code>Egress</code>-Ressource wird nun die Logik definiert: Welche Pods sollen die dedizierte Egress-IP verwenden? In diesem Beispiel selektieren wir gezielt einen Pod im <code>default</code>-Namespace.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Egress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-evoila-demo-1-egress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">namespaceSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">kubernetes.io/metadata.name</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">podSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-evoila-demo-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">externalIPPool</span><span class="p">:</span><span class="w"> </span><span class="l">egress1-ext-ippool</span><span class="w">
</span></span></span></code></pre></div><h4 id="validierung-und-test-der-konfiguration">Validierung und Test der Konfiguration</h4>
<p>Um sicherzustellen, dass die Konfiguration korrekt greift und der Traffic tats√§chlich die zugewiesene IP aus dem Antrea-Pool nutzt, f√ºhren wir einen einfachen Test durch.</p>
<p>F√ºr die Validierung nutze ich ein Test-Deployment innerhalb des Kubernetes-Clusters und f√ºhre einen <code>curl</code>-Befehl gegen ein Ziel au√üerhalb der NSX-Umgebung aus. Als Ziel dient ein kleiner <strong>FastAPI-Container</strong>, der so konfiguriert ist, dass er lediglich die IP-Adresse des Anfragenden (<strong>Requester IP</strong>) im Body zur√ºckgibt.</p>
<p>Wir loggen uns in einen Pods ein und senden den Request:</p>
<figure><a href="egress-test.png"><img src="/nsx_vpc_vks/egress-test.png"
      alt="Egress Test"></a><figcaption>
        <p>Egress Test √úbersicht ‚Äì Klick zum Vergr√∂√üern</p>
      </figcaption>
  </figure>


            </div>
        </article></main>
</div>
<footer class="footer">
    <span class="footer_item"> </span>
    &nbsp;

    <div class="footer_social-icons">
<a href="https://github.com/vi-universe" target="_blank" rel="noopener noreferrer me"
    title="Github">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22">
    </path>
</svg>
</a>
<a href="https://www.linkedin.com/in/christian-kremer-it" target="_blank" rel="noopener noreferrer me"
    title="LinkedIn">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path>
    <rect x="2" y="9" width="4" height="12"></rect>
    <circle cx="4" cy="4" r="2"></circle>
</svg>
</a>
<a href="/index.xml" target="_blank" rel="noopener noreferrer me"
    title="Rss">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path d="M4 11a9 9 0 0 1 9 9" />
    <path d="M4 4a16 16 0 0 1 16 16" />
    <circle cx="5" cy="19" r="1" />
</svg>
</a>
</div>
    <small class="footer_copyright">
        ¬© 2026 Christian Kremer.
        Unterst√ºtzt durch <a href="https://github.com/hugo-sid/hugo-blog-awesome" target="_blank" rel="noopener">Hugo blog awesome</a>.
    </small>
</footer><a href="#" title="Zum Seitenanfang" id="totop">
    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" stroke="currentColor" viewBox="0 96 960 960">
    <path d="M283 704.739 234.261 656 480 410.261 725.739 656 677 704.739l-197-197-197 197Z"/>
</svg>

</a>


    




    
    
        
    

    
    
        
    



    
    <script async src="http://localhost:1313/js/main.js" ></script>

    

</body>
</html>
